 RGet started: a very simple working example 

## Load the packages

```{r}

#install.packages("devtools")
#library(devtools)
devtools::load_all()
library(lubridate)
library(patchwork)
library(tidybayes)
library(ggdist)

## KNOWN INFECTIONS
## KNOWN EXPSOURES

```

## Get data in the right format for rjmcmc model


To help with this section please consult information in the documentation on how to layour this data.frame:

* For serological data in observational model see [data_titre](../man/data_titre.Rd).
* For known exposure times [data_known_exposures](./man/data_known_exposures.Rd).
* For exposure prior see XXX.

```{r}

# Load data clean in the format required for the model
data_titre_null <- data.frame(
    id = map(1:40, ~rep(.x, 2)) %>% unlist,
    time = rep(c(0, 30), 40),
    IgG = c(0, 2, 0, 2, 0, 2, 0, 2, rep(3, 72))
   #IgG = c(0, 2, 0, 2, 0, 2, 0, 2, 0, 2, rep(3, 10))
 )

# No known exposure times in this model 
data_known_null <- data.frame(
    id = c(1, 2, 3, 4),
    time = c(15, 15, 15, 15),
    exposure_type = c("delta")
)

data_known_null <- NULL

exp_prior_null <- data.frame(
    day = 1:30,
    prob = 1/30
)# This is the empirical prior for the exposure time

known_exp <- NULL #rep(15, 10)

```

## Define the functions required for the rjmcmc model

To help with this section please consult information in the documentation on how to define these functions:

* For observation functions see [obsLogLikelihood](./man/obsLogLikelihood.Rd).
* For COP model functions [copLogLikelihood](./man/copLogLikelihood.Rd).
* For antibody kinetics functions see [abkineticsFunction](./man/abkineticsFunction.Rd).

```{r}

# This function uses a cauchy distribution for the likelihood of the titre values with a LOD a titre value ofg log10(40)
obsLogLikelihood = function(titre_val, titre_est, pars) {

    ll <- dnorm(titre_val, titre_est, pars[1], log = TRUE)
    ll
}

# This function calcualtes the probability of infection given exposure
copFuncForm <- function(inf_status, esttitreExp, params) {
    beta0 <- params[1]
    beta1 <- params[2]
    p <- 1.0 / (1.0 + exp(- (beta0 + beta1 * esttitreExp) ) )
}

#b0 < log(9)
#b1 > -b0/4

b0_sample <- runif(1000, -1, 10)
a_sample <- runif(1000, 0, 2)
b1_sample <- -b0_sample/4 - a_sample

df_prior <- data.frame(b0_sample = b0_sample, b1_sample = b1_sample)

summary_df <- 1:1000 %>%
    map_df(
        ~data.frame(
            titre = seq(0, 4, 0.5),
            prop = copFuncForm(0,  seq(0, 4, 0.5), as.numeric(df_prior[.x, ]))
        )
    ) %>% group_by(titre) %>% mean_qi(prop)

summary_df %>% ggplot() + 
    geom_ribbon(aes(x = titre, ymin = .lower, ymax = .upper), fill = "lightgray") + 
    geom_line(aes(titre, prop))

lol <- copFuncForm(0, seq(0:4), c(1.094016, -5.189966))
lol



# This function uses a logistic distribution for the likelihood.
copLogLikelihood <- function(inf_status, esttitreExp, params) {
    # COP parameters
    beta0 <- params[1]
    beta1 <- params[2]
    p <- copFuncForm(inf_status, esttitreExp, params)
    ll <- inf_status * log(p) + (1 - inf_status) * log(1 - p)
    ll <- 0
    ll
}

# This function uses describes the antibody kinetics model for the time until infection
noInfSerumKinetics <- function(titre_est, timeSince, pars) {
    titre_est <- titre_est - pars[1] * (timeSince)
    titre_est <- max(0, titre_est)
  #  titre_est <- 3
    titre_est
}

# This function uses describes the antibody kinetics model after infection
infSerumKinetics <- function(titre_est, timeSince, pars) {
    a <- pars[1] 
    if (timeSince < 14) {
        titre_est <- titre_est + a;
    } else {
        titre_est <- titre_est + a;
    }
    #titre_est <- 3
    titre_est
}

```


## Define the models for the rjmcmc model

To help with this section please consult information in the documentation on how to define these lists:

* For observation model see [observationalModel](./man/observationalModel.Rd).
* For COP model see [copModel](./man/copModel.Rd).
* For antibody kinetics see [abkineticsModel](./man/abkineticsModel.Rd).

```{r}


# Define the biomarkers and exposure types in the model
biomakers <- c("IgG")
exposureTypes <- c("none", "delta")
exposureFitted <- "delta"

# Define the observational model
observationalModel <- list(
    names = c("IgG"),
    model = makeModel(addObservationalModel("IgG", c("sigma"), obsLogLikelihood)),
    prior = add_par_df("sigma", 0.0001, 4, "unif", 0.0001, 4) # observational model,
)

# Define the antibody kinetics model
abkineticsModel <- list(
    names = c("none", "delta"),
    model = makeModel(
            addAbkineticsModel("none", "IgG", "none",  c("wane"), noInfSerumKinetics),
            addAbkineticsModel("delta","IgG", "delta", c("a_d"), infSerumKinetics)
        ),
    prior = bind_rows(
        add_par_df("a_d", -4, 4, "norm",  1, 1), # ab kinetics
        add_par_df("wane", 0.0, 0.1, "unif",  0, 1) # ab kinetics
    )
)

# Define the COP model
copModel <- list( 
        names = c("IgG"),
        model = makeModel(addCopModel("IgG", "delta", c("beta0", "beta1"), copFuncForm, copLogLikelihood)),
        prior = bind_rows(
            add_par_df("beta0", -10, 10, "unif", -10, 10), # cop model (not used here)
            add_par_df("beta1", -10, 10, "unif", -10, 10)
        ) # cop model (not used here),
)

modeldefinition <- list(
    biomarkers = biomakers,
    exposureTypes = exposureTypes,
    exposureFitted = exposureFitted,
    observationalModel = observationalModel,
    abkineticsModel = abkineticsModel,
    copModel = copModel,
    exposurePrior = exp_prior_null,
    exposurePriorType = "empirical"
)

modelNull <- createSeroJumpModel(data_titre_null, data_known_null, modeldefinition, known_exp)

````

# Define settings and run the model, (this won't run as made the data up)

```{r eval = FALSE}

# load all
devtools::load_all()

# Define the settings
settings <-  list(
    numberChainRuns = 4,
    numberCores = 4,
    iterations = 20000,
    burninPosterior = 10000,
    thin = 10,
    consoleUpdates = 100,
    onAdaptiveCov = TRUE,
    updatesAdaptiveCov = 10,
    burninAdaptiveCov = 1000,
    updatesAdaptiveTemp = 10,
    covarInitVal = 1e-2, # make very small if struggling to sample to beginning
    covarInitValAdapt = 1e-2, # make very small if struggling to sample to beginning
    covarMaxVal = 1, # decrease if struggling to sample in the middle
    runParallel = TRUE,
    noGibbsSteps = 1,
    onDebug = FALSE
)

# Run the model 
runRJMCMC(modelNull, settings, "local/null", "modelA")
postprocessFigs("local/null", "modelA", 4)


```


```{r}

p <- 0.5

tot_inf <- vector()

for (i in 1:1000) {
    p <- runif(1, 0, 1)
    tot_inf[i] <- rbernoulli(100, p) %>% as.numeric %>% sum 
}

library(VGAM)

# Define parameters
n <- 10  # Number of trials
k <- 3   # Number of successes
alpha <- 2  # Shape parameter of the Beta distribution
beta <- 2   # Shape parameter of the Beta distribution

# Calculate the PMF of the Beta-Binomial distribution
dbeta(seq(0, 1, 0.1), 1/200, 1/200)
pmf <- dbetabinom.ab(0:200, 200, 1/200, 1/200) %>% log

n <- 14
k <- 10
choose(n, k) * beta(k + 1, n - k + 1)


betabinom

tot_inf %>% hist

```